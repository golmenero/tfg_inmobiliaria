{% extends "../base.html" %} {% block titulo %} ARCA Inmobiliaria {% endblock %}

{% block contenido_principal %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a class="breadcrumb-custom" href="/">Inicio</a></li>
        <li class="breadcrumb-item"><a class="breadcrumb-custom" href="/conversations">Conversaciones</a></li>
        <li class="breadcrumb-item active breadcrumb-custom" aria-current="page">Conversación</li>
    </ol>
</nav>
<div class="container">
    <h1 class="sectionHeader">Sala de chat</h1>
    <div class="row">
        <div class="col-11">
            <h2>{{conversation.property.name}} ({{conversation.property.type}})</h2>
            <h3>Operación: {{conversation.property.typeOp}}/{{conversation.property.price}} €</h3>
        </div>
        <div class="col-1">
            <a class="btn btn-dark float-right"
               href="/properties/details/{{conversation.property._id.toString() }}"><span
                    class="far fa-eye"></span> Ver Inmueble</a>
        </div>
    </div>

    <form class="inline-form" method="post" action="/conversations/send/{{conversation._id.toString()}}"
          encType="multipart/form-data">
        <div id="message-container" class="message-container overflow-auto">
            {% for message in conversation.messages %}
            {% if user.permission == message.from %}
            <div>
                <p class="message-pr">{{message.text}}
                <span class="message-date-pr">{{message.date}} ~ {{message.time}}</span>
                </p>
            </div>
            {% else %}
            <div>
                <p class="message-pl">{{message.text}}
                    <span class="message-date-pr">{{message.date}} ~ {{message.time}}</span>
                </p>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        <label class="control-label input-label" for="messageInput">Escribe un mensaje y pulsa enviar.</label>
        <div class="input-chat row">
            <input class="col-10 form-control" type="text" name="messageInput" id="messageInput" title="Escribe un mensaje">
            <button id="btnEnviarMensaje" class="col-2 btn btn-dark" type="submit">Enviar</button>
        </div>
    </form>
    <script>

        function actualiza(data) {
            $.ajax({
                type: 'POST',
                data: data,
                url: '/conversations/loadMsg',
            }).done(function (data) {
                let msgs = data.newMessages;
                for (let i = 0; i < msgs.length; i++) {
                    let message = msgs[i];
                    if (message.from == '{{user.permission}}') {
                        $('#message-container').append("<div><p class=\"message-pr\">" + message.text + "<span class=\"message-date-pr\">" + message.date + '~' +  message.time + "</span></p></div>");
                    } else {
                        $('#message-container').append(" <div><p class=\"message-pl\">" + message.text + "<span class=\"message-date-pr\">" + message.date + '~' +  message.time + "</span></p></div>");
                    }
                }
            });
        }

        $(document).ready(function () {
            let data = {
                _id: "{{conversation.id}}",
                permission: '{{user.permission}}'
            }

            console.log(data)
            if (data._id != "") {
                update(data);
                let func = setInterval(function () {
                    actualiza(data);
                }, 1000)
            }
        });
    </script>
</div>
{% endblock %}
